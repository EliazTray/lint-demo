export { default as theme } from './src/index'
import { Head, Image, Notes } from 'mdx-deck'
import nightOwl from 'prism-react-renderer/themes/nightOwl'
import { CodeSurfer } from 'mdx-deck-code-surfer'
import { LayoutNoFooter, Layout, Split, BGImage } from './src/index'

<Head>
  <title>Linter</title>
</Head>

export default Layout

# Linter

> author eliaztray

---

# 主题

1. 你听说或者使用过哪些 linter ?

2. 你清楚它们是如何使用的吗 ?

3. 你清楚它们是如何运作的吗 ?

4. 制作一个简化版的 linter.

<Notes>
  <p>
    {' '}
    1. 4 是我们这次分享的重点，希望大家通过这次分享，可以帮助大家大概知道 一个 linter 是如何实现的。
  </p>
</Notes>

---

export default Layout

# 你听说或者使用过哪些 linter ?

---

export default Split

- js
- `jslint`
- `jshint`
- `eslint`
- `tslint`

* css
* `csslint`
* `stylelint`
* ..more

<Notes>
  <li>
    {' '}
    html template 这块还有 vuter, 会有一些linter的校验，功能是基于 postcss-html 这个 plugin 支持的
  </li>
  <li> 这里可能有人会说 prettier, 其实 prettier 只算得上是 code formatter。</li>
</Notes>

---

# 你清楚它们是如何使用的吗 ?

<Notes>
  <li> 想必大家觉得很简单了。</li>
</Notes>

---

## step 1

Add dependencies in your project

---

<CodeSurfer
  theme={nightOwl}
  lang="bash"
  code={`
    yarn add eslint eslint-config-xo -D\n\n
    npm i eslint eslint-config-xo -D
  `}
/>

---

## step 2

Create a config like `.eslintrc`, `.eslintrc.js`, or in `packageProps`.

---

<CodeSurfer
  theme={nightOwl}
  lang="json"
  code={`
    {
      "extends": [
        "plugin:vue/essential",
        "@vue/prettier"
      ]
    }
  `}
/>

---

## step 3

Combine with `husky` & `lint-staged` in git hooks like `pre-commit`.

---

<CodeSurfer
  theme={nightOwl}
  lang="json"
  code={`
  {
    "husky": {
      "hooks": {
        "pre-commit": "lint-staged"
      }
    },
    "lint-staged": {
      "*.js": [
        "prettier --write",
        "standard --fix",
        "git add"
      ],
      "*.{json,md}": [
        "prettier --write",
        "git add"
      ]
    }
  }
  `}
/>

---

# 你清楚它们是如何运作的吗 ?

---

<CodeSurfer
  theme={nightOwl}
  lang="bash"
  code={`
    eslint . --fix
  `}
/>

<Notes>
  <li>当我们从命令行中键入 这串字符的时候 他背后实际上执行了什么样的操作呢，接下来我们就会稍微具体的讲下这个过程是如何实现的</li>
  <li>在深入代码前，让我们说下 AST 这个东西。 </li>
</Notes>

---

## 开始制作一个简单 linter (BASE ON CSS)

---

export default Split

使用 4 个分支讲述 linter 实现

- step-1-base
- step-2-cosmiconfig
- step-3-cli
- step-4-unittest

---

<Notes>
  <li>为什么按照4个分支来讲，一般来说。</li>
  <ol>转换函数</ol>
  <ol>规则</ol>
  <ol>有良好的信息输出，良好的信息输出标识，错误提示和修复建议 </ol>
  <ol>可自定义配置文件 </ol>
  <ol>cli, 命令行工具 </ol>
  <ol>单元测试，随着功能增多，我们需要保证代码的质量</ol>
  <li>接下来就用一些代码来讲述这个过程</li>
</Notes>

## step-1-base

---

<CodeSurfer
  theme={nightOwl}
  title="selector-type-case"
  lang="js"
  code={`
      const parseSelector = require('../lib/parseSelector')
      const reportMessage = require('../utils/report')\n
      module.exports = function checkSelectorTypeCase (root, needfix = false, checkName = 'lower') {
      root.walkRules(rule => {
        parseSelector(rule.selector, selectorAST => {
          selectorAST.walkTags(tag => {
            const value = tag.value
            const sourceIndex = tag.sourceIndex
            const expectedValue = checkName === 'lower'
              ? value.toLowerCase()
              : value.toUpperCase()
            if (value === expectedValue) {
              return
            }
            if (needfix) {
              rule.selector =
                rule.selector.slice(0, sourceIndex) +
                expectedValue +
                rule.selector.slice(sourceIndex + value.length)
              return
            }
            reportMessage(rule, 'selector-type-case', sourceIndex, expectedValue, value)
          })
        })
      })
  `}
  steps={[
    { notes: 'rules for css' },
    { lines: [6], notes: 'walkRules for root' },
    { lines: [7], notes: 'parse selector for rule' },
    { lines: [24], notes: 'report message if not need fix' }
  ]}
/>

---

## step-2-cosmiconfig


<Notes>
  <li>前面看到有 .eslintrc .eslint.config.js 这些配置文件，里面定义的就是他的配置</li>
</Notes>


---

<CodeSurfer
  theme={nightOwl}
  title="SearchPlaces"
  lang="json"
  code={`
    [
      'package.json'
      '.eslintrc',
      '.eslintrc.json',
      '.eslintrc.yaml',
      '.eslintrc.yml',
      '.eslintrc.js',
      '.eslint.config.js'
    ]
  `}
/>

---

<CodeSurfer
  theme={nightOwl}
  title="Get config"
  lang="js"
  code={`
    const cosmiconfig = require('cosmiconfig')\n
    function getConfig (configName = 'clint') {
      const explorer = cosmiconfig(configName)
      const searchResult = explorer.searchSync()
      if (!searchResult) {
        throw new TypeError('Please provide the config')
      }
      return searchResult.config
    }
  `}
  steps={[
    { notes: 'get config for our custom name `clint`' },
    { lines: [5], notes: 'init explorer' },
    { lines: [8], notes: 'throw an error' }
  ]}
/>

---

## step-3-cli

---

<CodeSurfer
  theme={nightOwl}
  title="Init CLI"
  lang="js"
  code={`
    #!/usr/bin/env node
    const cac = require('cac')
    const { version } = require('./package.json')
    const main = require('./src/index')
    const cli = cac()\n
    cli
      .command('<files>', 'use globby pattern match the files')
      .option('--config <configPath>', 'specify the clint config')
      .option('--fix', 'fix the error')
      .allowUnknownOptions()
      .action((path, options) => {
        main(path, options)
      })\n
    cli.help()
    cli.version(version)
    cli.parse()
  `}
  steps={[
    { lines: [9], notes: 'specify input files' },
    { range: [10, 12], notes: 'accept options' }
  ]}
/>

---

## step-4-unittest

---

<CodeSurfer
  theme={nightOwl}
  title="Add unit test"
  lang="js"
  code={require('!raw-loader!../test/index.test.js').default}
  steps={[
    { notes: 'add test' },
    { range: [27, 44], notes: 'test for rules `seletor-type-case`' },
    { tokens: { 28: [4, 5, 6, 7, 8, 9] } },
    { tokens: { 30: [3, 4, 5, 6, 7] } }
  ]}
/>

---

<CodeSurfer
  theme={nightOwl}
  lang="diff"
  code={require('!raw-loader!../snippets/diff').default}
  steps={[
    { range: [1, 2], notes: '`A` tag was transformed to lower case' },
    { range: [7, 8], notes: '`UL LI` tags were transformed to lower case' }
  ]}
/>

---


1. 你听说或者使用过哪些 linter ?

2. 你清楚它们是如何使用的吗 ?

3. 你清楚它们是如何运作的吗 ?

4. 制作一个简化版的 linter.

---

## [https://lint.eliaztray.cn](https://lint.eliaztray.cn)

## [https://github.com/eliaztray/lint-demo](https://github.com/eliaztray/lint-demo)

---

# Thank You!
